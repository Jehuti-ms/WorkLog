<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WorkLog - Student Tracker</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="icon" href="icons/icon-192x192.png" type="image/png">

    <!-- Styles -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="auth.css">
    
    <!-- Enhanced Auth Bar Styles -->
    <style>
        .auth-bar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            border-bottom: 1px solid #e8ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .auth-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-welcome {
            font-weight: 600;
            color: #667eea;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
        }

        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .sync-connected { background: #28a745; }
        .sync-syncing { background: #ffc107; animation: pulse 1.5s infinite; }
        .sync-pending { background: #ffc107; animation: pulse 2s infinite; }
        .sync-error { background: #dc3545; }
        .sync-offline { background: #6c757d; }

        .auth-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Enhanced Auth Bar with Logout -->
    <div class="auth-bar">
        <div class="auth-info">
            <span class="user-welcome" id="userWelcome">Welcome to WorkLog! Please sign in</span>
            <span class="sync-status" id="syncStatus">
                <span class="sync-indicator sync-offline"></span>
                Loading...
            </span>
        </div>
        <div class="auth-actions">
            <button class="btn btn-primary btn-sm" id="showAuthBtn">Sign In / Register</button>
            <button class="btn btn-secondary btn-sm" id="logoutBtn" style="display: none;" onclick="Auth.logout()">
                üö™ Logout
            </button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Header -->
        <header class="app-header">
            <h1>
                <img src="icons/app-icon.svg" alt="Work Log" class="app-icon">
                Work Log
            </h1>
            <p class="subtitle">Student Tracker & Hours Management System</p>
            <div class="storage-status">
                <span class="status connected">üíæ Local Storage</span>
                <button class="btn btn-secondary btn-sm" id="exportDataBtn">üì§ Export Data</button>
                <button class="btn btn-secondary btn-sm" id="importDataBtn">üì• Import Data</button>
                <button class="btn btn-warning btn-sm" id="clearAllDataBtn">üóëÔ∏è Clear All</button>
            </div>
        </header>

        <!-- Rest of your app content remains exactly the same -->
        <!-- Navigation Tabs -->
        <div class="tabs-container">
            <div class="tabs">
                <button class="tab active" data-tab="students">üë• Students</button>
                <button class="tab" data-tab="attendance">üìÖ Attendance</button>
                <button class="tab" data-tab="hours">‚è∞ Hours Tracker</button>
                <button class="tab" data-tab="marks">üìù Marks Register</button>
                <button class="tab" data-tab="payments">üí∞ Payments</button>
                <button class="tab" data-tab="reports">üìà Reports</button>
            </div>
        </div>

        <!-- All your tab contents remain exactly the same -->
        <div class="tab-content active" id="students">
            <!-- Your existing students tab content -->
        </div>

        <div class="tab-content" id="attendance">
            <!-- Your existing attendance tab content -->
        </div>

        <div class="tab-content" id="hours">
            <!-- Your existing hours tab content -->
        </div>

        <div class="tab-content" id="marks">
            <!-- Your existing marks tab content -->
        </div>

        <div class="tab-content" id="payments">
            <!-- Your existing payments tab content -->
        </div>

        <div class="tab-content" id="reports">
            <!-- Your existing reports tab content -->
        </div>
    </div>

    <!-- Your existing modals -->
    <div id="paymentModal" class="modal">
        <!-- Your existing payment modal -->
    </div>

    <div id="attendanceSessionModal" class="modal">
        <!-- Your existing attendance modal -->
    </div>

    <!-- Include auth modals -->
    <div id="auth-modals-container"></div>

    <input type="file" id="importFile" style="display: none" accept=".json">
    
    <!-- Scripts -->
    <script src="auth.js"></script>
    <script src="app.js"></script>
    
    <script>
        // Enhanced initialization with logout button handling
        async function initializeApp() {
            try {
                // Load auth modals
                const response = await fetch('auth.html');
                const html = await response.text();
                document.getElementById('auth-modals-container').innerHTML = html;
                
                // Initialize auth system
                if (typeof Auth !== 'undefined') {
                    await Auth.initialize();
                    // Update UI based on auth state
                    updateAuthUI();
                }
                
                // Initialize main app
                if (typeof init === 'function') {
                    init();
                }
                
                // Setup auth button listeners
                setupAuthListeners();
                
            } catch (error) {
                console.error('Error initializing app:', error);
                // Fallback
                if (typeof init === 'function') {
                    init();
                }
            }
        }

        // Update auth UI based on login state
        function updateAuthUI() {
            const showAuthBtn = document.getElementById('showAuthBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const userWelcome = document.getElementById('userWelcome');
            
            if (Auth.isAuthenticated()) {
                const user = Auth.getCurrentUser();
                if (user) {
                    userWelcome.textContent = `Welcome, ${user.name}!`;
                    showAuthBtn.style.display = 'none';
                    logoutBtn.style.display = 'inline-block';
                }
            } else {
                userWelcome.textContent = 'Welcome to WorkLog! Please sign in';
                showAuthBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'none';
            }
        }

        // Setup auth button listeners
        function setupAuthListeners() {
            const showAuthBtn = document.getElementById('showAuthBtn');
            if (showAuthBtn) {
                showAuthBtn.onclick = function() {
                    if (typeof Auth !== 'undefined') {
                        if (Auth.isAuthenticated()) {
                            Auth.showProfileModal();
                        } else {
                            Auth.showAuthModal();
                        }
                    }
                };
            }
        }

        // Listen for auth state changes
        document.addEventListener('authStateChanged', function() {
            updateAuthUI();
        });

        // Start the app
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
