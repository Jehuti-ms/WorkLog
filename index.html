<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WorkLog - Student Tracker & Hours Management</title>
    <link rel="stylesheet" href="styles.css">
    <!-- REMOVED: auth.css - should not be here -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- SECURITY OVERLAY REMOVAL -->
    <script>
        // Remove any fake overlays immediately
        window.addEventListener('DOMContentLoaded', function() {
            const suspiciousElements = document.querySelectorAll([
                '[style*="position: fixed"]',
                '[style*="z-index: 9999"]',
                '[style*="z-index: 99999"]',
                '.auth-container',
                '.auth-card'
            ].join(','));
            
            suspiciousElements.forEach(el => {
                if (el.offsetWidth > 300 || el.innerHTML.includes('Sign In') || el.innerHTML.includes('Login')) {
                    console.log('Removing suspicious overlay:', el);
                    el.remove();
                }
            });
            
            // Also remove any iframes
            document.querySelectorAll('iframe').forEach(iframe => iframe.remove());
        });
    </script>

    <div class="container">
        <!-- Header Section -->
        <header class="header">
            <h1>ğŸ“š WorkLog</h1>
            <p class="subtitle">Student Tracker & Hours Management System</p>
            
            <div class="storage-status">
                <span class="status" id="localStatus">ğŸ’¾ Local Storage: Active</span>
                <span class="status" id="syncStatus">â˜ï¸ Cloud Sync: Ready</span>
                <span class="status" id="dataStatus">ğŸ“Š Data: 0 Students, 0 Sessions</span>
                
                <!-- Updated Auth Section -->
                <div class="auth-section" style="display: inline-block; margin-left: 10px;">
                    <button class="btn btn-sm" id="authButton">Sign In</button>
                    <div id="userMenu" class="user-menu" style="display: none;">
                        <div class="user-info">
                            <span id="userName">User</span>
                        </div>
                        <button class="user-menu-item" onclick="window.Auth.showProfileModal()">
                            ğŸ‘¤ Profile & Settings
                        </button>
                        <button class="user-menu-item" onclick="window.Auth.logoutUser()">
                            ğŸšª Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Cloud Sync Bar -->
        <div class="cloud-sync-bar">
            <div class="sync-status">
                <span class="sync-indicator sync-connected"></span>
                <span id="syncMessage">All changes saved locally</span>
            </div>
            <div class="sync-controls">
                <button class="btn btn-sm" id="syncBtn" style="display: none;">ğŸ”„</button>
                <button class="btn btn-sm" onclick="exportData()">ğŸ“¤ Export Data</button>
                <button class="btn btn-sm btn-secondary" onclick="importData()">ğŸ“¥ Import Data</button>
                <button class="btn btn-sm btn-danger" onclick="clearAllData()">ğŸ—‘ï¸ Clear All</button>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tabs-container">
            <div class="tabs">
                <button class="tab active" data-tab="students">
                    ğŸ‘¥ Students
                </button>
                <button class="tab" data-tab="hours">
                    â±ï¸ Hours
                </button>
                <button class="tab" data-tab="marks">
                    ğŸ“Š Marks
                </button>
                <button class="tab" data-tab="attendance">
                    âœ… Attendance
                </button>
                <button class="tab" data-tab="payments">
                    ğŸ’° Payments
                </button>
                <button class="tab" data-tab="reports">
                    ğŸ“ˆ Reports
                </button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="content">
            <!-- Students Tab -->
            <div id="students" class="tab-content active">
                <div class="section-header">
                    <h2>ğŸ“š Student Management</h2>
                    <div class="student-stats">
                        <span class="stat-badge" id="studentCount">0</span>
                        <span class="stat-divider">|</span>
                        <span class="stat-text">Avg Rate: $<span id="averageRate">0.00</span>/session</span>
                    </div>
                </div>

                <!-- Default Rate Settings Panel -->
                <div class="default-rate-panel">
                    <h4>ğŸ’° Default Rate Settings</h4>
                    <div class="form-group">
                        <label for="defaultBaseRate">Default Base Rate ($/session)</label>
                        <input type="number" id="defaultBaseRate" step="0.01" min="0" placeholder="e.g., 25.00">
                        <div class="help-text">This rate will be automatically filled for new students.</div>
                        <div class="current-rate-display">
                            Current: $<span id="currentDefaultRate">0.00</span>
                        </div>
                    </div>
                    <div class="rate-actions">
                        <button type="button" class="btn btn-success" onclick="saveDefaultRate()">
                            ğŸ’¾ Save Default Rate
                        </button>
                        <button type="button" class="btn btn-warning" onclick="applyDefaultRateToAll()">
                            ğŸ”„ Apply to All Students
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="useDefaultRate()">
                            ğŸ“ Use in Form
                        </button>
                    </div>
                </div>

                <!-- Student Registration Form -->
                <div class="section-card">
                    <h3>ğŸ‘¤ Student Registration</h3>
                    <form id="studentForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="studentName">Full Name *</label>
                                <input type="text" id="studentName" placeholder="Enter student's full name" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="studentId">Student ID *</label>
                                <input type="text" id="studentId" placeholder="Enter unique student ID" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="studentGender">Gender *</label>
                                <select id="studentGender" required>
                                    <option value="">Select gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="studentEmail">Email Address</label>
                                <input type="email" id="studentEmail" placeholder="student@email.com">
                            </div>
                            
                            <div class="form-group">
                                <label for="studentPhone">Phone Number</label>
                                <input type="tel" id="studentPhone" placeholder="+1 (555) 123-4567">
                            </div>
                            
                            <div class="form-group">
                                <label for="studentBaseRate">
                                    Base Rate ($/session) 
                                    <span class="auto-fill-hint">Auto-fills from default</span>
                                </label>
                                <input type="number" id="studentBaseRate" step="0.01" min="0" placeholder="e.g., 25.00">
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-primary" id="addStudentBtn" onclick="addStudent()">
                                â• Add Student
                            </button>
                            <button type="button" class="btn btn-success" id="updateStudentBtn" onclick="updateStudent()" style="display: none;">
                                âœï¸ Update Student
                            </button>
                            <button type="button" class="btn btn-secondary" id="cancelEditBtn" onclick="cancelEdit()" style="display: none;">
                                âŒ Cancel Edit
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="clearStudentForm()">
                                ğŸ—‘ï¸ Clear Form
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Student List -->
                <div class="section-card">
                    <div class="section-header">
                        <h3>ğŸ“‹ Registered Students</h3>
                        <div class="list-controls">
                            <div class="search-box">
                                <input type="text" id="studentSearch" placeholder="ğŸ” Search students...">
                            </div>
                        </div>
                    </div>
                    
                    <div class="students-container" id="studentsContainer">
                        <p style="color: #666; text-align: center; padding: 40px;">
                            No students registered yet. Add your first student above!
                        </p>
                    </div>
                </div>
            </div>

            <!-- Rest of your content remains exactly the same -->
            <!-- Hours Tab -->
            <div id="hours" class="tab-content">
                <!-- ... keep all your existing hours tab content ... -->
            </div>

            <!-- Marks Tab -->
            <div id="marks" class="tab-content">
                <!-- ... keep all your existing marks tab content ... -->
            </div>

            <!-- Attendance Tab -->
            <div id="attendance" class="tab-content">
                <!-- ... keep all your existing attendance tab content ... -->
            </div>

            <!-- Payments Tab -->
            <div id="payments" class="tab-content">
                <!-- ... keep all your existing payments tab content ... -->
            </div>

            <!-- Reports Tab -->
            <div id="reports" class="tab-content">
                <!-- ... keep all your existing reports tab content ... -->
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <!-- ... keep your modal content ... -->
    </div>

    <!-- Session Attendance Modal -->
    <div id="attendanceSessionModal" class="modal">
        <!-- ... keep your modal content ... -->
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="importFile" accept=".json" style="display: none;">

    <!-- ==================== -->
    <!-- CORRECT SCRIPT ORDER -->
    <!-- ==================== -->
    
    <!-- 1. Auth system first -->
    <script src="auth.js"></script>
    
    <!-- 2. Cloud sync second -->
    <script src="cloud-sync.js"></script>
    
    <!-- 3. Main app LAST -->
    <script src="app.js"></script>

    <!-- ==================== -->
    <!-- PROPER INITIALIZATION -->
    <!-- ==================== -->
    <script>
        // Proper initialization sequence
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== WORKLOG APP INITIALIZATION ===');
            
            // Step 1: Initialize authentication FIRST
            if (typeof initAuth === 'function') {
                console.log('Initializing auth system...');
                initAuth();
            } else {
                console.error('âŒ Auth system not found!');
            }
            
            // Step 2: Check authentication status
            setTimeout(function() {
                if (window.Auth && window.Auth.isAuthenticated()) {
                    console.log('âœ… User authenticated, initializing main app...');
                    // Initialize main app
                    if (typeof init === 'function') {
                        init();
                    }
                } else {
                    console.log('âŒ User not authenticated');
                    // Update UI to show login required
                    const authBtn = document.getElementById('authButton');
                    if (authBtn) {
                        authBtn.textContent = 'ğŸ” Login Required';
                        authBtn.style.background = '#ffc107';
                        authBtn.style.color = '#212529';
                        authBtn.onclick = function() {
                            window.location.href = 'auth.html';
                        };
                    }
                    
                    // Disable all interactive elements
                    document.querySelectorAll('button, input, select, textarea').forEach(el => {
                        if (el.id !== 'authButton') {
                            el.disabled = true;
                        }
                    });
                }
            }, 100);
        });
    </script>
    <!-- DEBUG SCRIPT - Add this right before </body> -->
<script>
    // Debug authentication status
    console.log('=== AUTH DEBUG INFO ===');
    console.log('Window.Auth exists:', !!window.Auth);
    console.log('isAuthenticated function exists:', !!(window.Auth && window.Auth.isAuthenticated));
    console.log('Auth state:', window.Auth ? window.Auth.isAuthenticated() : 'No Auth object');
    console.log('Current user:', window.Auth ? window.Auth.getCurrentUser() : 'No user');
    console.log('Session in localStorage:', localStorage.getItem('worklog_session'));
    
    // Check if user menu elements exist
    const authButton = document.getElementById('authButton');
    const userMenu = document.getElementById('userMenu');
    console.log('Auth button exists:', !!authButton);
    console.log('User menu exists:', !!userMenu);
    
    // Force show user menu for testing
    if (authButton && userMenu) {
        console.log('Setting up auth button click handler...');
        authButton.onclick = function() {
            console.log('Auth button clicked!');
            if (userMenu.style.display === 'block') {
                userMenu.style.display = 'none';
            } else {
                userMenu.style.display = 'block';
            }
        };
    }
</script>
</body>
</html>
